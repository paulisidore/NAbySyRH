<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button fill="clear" color="light" (click)="_openSideNav()">
        <ion-icon slot="icon-only" name="menu"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Gestion des Paiements de Salaires</ion-title>
  </ion-toolbar>
  
  <ion-toolbar color="light">
    <ion-grid class="header-actions">
      <ion-row class="ion-align-items-center">
        <ion-col size="12" size-md="4">
          <!-- Sélection de période -->
          <ion-item id="open-modal" lines="none" class="period-selector">
            <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
            <ion-label>Période</ion-label>
            <ion-text class="period-text">{{ formattedString | date:'MMMM yyyy' }}</ion-text>
            <ion-icon name="chevron-down-outline" slot="end" color="medium"></ion-icon>
          </ion-item>

          <ion-modal trigger="open-modal" mode="md">
            <ng-template>
              <ion-content>
                <ion-datetime
                  #datetime
                  [value]="dateValue"
                  size="cover"
                  displayFormat="MMMM yyyy"
                  pickerFormat="MMMM yyyy"
                  (ionChange)="dateChanged(datetime.value)"
                  (ionCancel)="showPicker=false;"
                >
                </ion-datetime>
                <ion-row class="modal-actions">
                  <ion-col size="4">
                    <ion-button (click)="close()" color="danger" expand="block">
                      Annuler
                    </ion-button>
                  </ion-col>
                  <ion-col size="4">
                    <ion-button (click)="effacedateDebut()" color="warning" expand="block">
                      Effacer
                    </ion-button>
                  </ion-col>
                  <ion-col size="4">
                    <ion-button (click)="selectPeriode()" color="primary" expand="block">
                      Valider
                    </ion-button>
                  </ion-col>
                </ion-row>
              </ion-content>
            </ng-template>
          </ion-modal>
        </ion-col>

        <ion-col size="12" size-md="8">
          <!-- Actions principales -->
           <ion-button
              (click)="openPrimeModal()"
              color="success"
              expand="block"
              class="prime-btn"
              [disabled]="!listeEmploye || listeEmploye.length === 0"
            >
              <ion-icon slot="start" name="gift-outline"></ion-icon>
              Ajouter Prime
            </ion-button>
            
           <ion-button
              (click)="openRetenueModal()"
              color="warning"
              expand="block"
              class="retenue-btn"
              [disabled]="!listeEmploye || listeEmploye.length === 0"
            >
              <ion-icon slot="start" name="remove-circle-outline"></ion-icon>
              Ajouter Retenue
          </ion-button>
          
          <div class="action-buttons">
            <ion-button
              (click)="openExportMenu()"
              color="tertiary"
              expand="block"
              class="export-btn"
              [disabled]="!listeEmploye || listeEmploye.length === 0"
            >
              <ion-icon slot="start" name="cloud-download-outline"></ion-icon>
              Exporter
            </ion-button>

            <ion-button
              (click)="triggerFileInput()"
              color="secondary"
              expand="block"
              class="import-btn"
              [disabled]="!listeEmploye || listeEmploye.length === 0"
            >
              <ion-icon slot="start" name="cloud-upload-outline"></ion-icon>
              Importer
            </ion-button>
            
            <ion-button
              (click)="toggleEditMode()"
              [color]="isEditMode ? 'warning' : 'medium'"
              expand="block"
              class="edit-btn"
            >
              <ion-icon slot="start" [name]="isEditMode ? 'lock-open' : 'lock-closed'"></ion-icon>
              {{ isEditMode ? 'Verrouiller' : 'Modifier' }}
            </ion-button>
            
            <ion-button
              (click)="validatePayment()"
              color="success"
              expand="block"
              class="validate-btn"
              [disabled]="!selectedEmployees || selectedEmployees.length === 0"
            >
              <ion-icon slot="start" name="checkmark-circle"></ion-icon>
              Valider le paiement
            </ion-button>
          </div>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-progress-bar color="primary" *ngIf="isProcessing" [value]="progress"></ion-progress-bar>
  
  <!-- Progress bar fixe au centre avec overlay -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-container">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p class="loading-text">Chargement en cours...</p>
      <ion-progress-bar color="primary" type="indeterminate"></ion-progress-bar>
    </div>
  </div>

  <!-- Statistiques et filtres -->
  <div class="stats-filter-section">
    <ion-card class="stats-card">
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="6">
              <div class="stat-item">
                <ion-icon name="people-outline" color="primary"></ion-icon>
                <div class="stat-content">
                  <div class="stat-label">Employés sélectionnés</div>
                  <div class="stat-value">{{ selectedEmployees?.length || 0 }}</div>
                </div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6">
              <div class="stat-item">
                <ion-icon name="cash-outline" color="success"></ion-icon>
                <div class="stat-content">
                  <div class="stat-label">Total Salaires Nets</div>
                  <div class="stat-value">{{ getTotalNetSalary() | currency:'XOF':'symbol':'1.0-0' }}</div>
                </div>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Filtres -->
    <ion-card class="filter-card">
      <ion-card-content>
        <ion-grid>
          <ion-row class="ion-align-items-center">
            <ion-col size="12" size-md="6">
              <ion-item lines="none">
                <ion-icon name="search-outline" slot="start" color="primary"></ion-icon>
                <ion-input
                  [(ngModel)]="searchTerm"
                  placeholder="Rechercher par nom ou fonction..."
                  clearInput
                ></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="12" size-md="6">
              <ion-item lines="none">
                <ion-icon name="business-outline" slot="start" color="primary"></ion-icon>
                <ion-label>Boutique</ion-label>
                <ion-select 
                  placeholder="Toutes les boutiques" 
                  [(ngModel)]="idBoutiqueAPayer" 
                  (ngModelChange)="this.loadEmploye()"
                  interface="popover"
                >
                  <ion-select-option value="0">(Toutes les Boutiques)</ion-select-option>
                  <ion-select-option *ngFor="let boutique of listeBoutiqueKSSV" [value]="boutique.ID">
                    {{ boutique.NOM }}
                  </ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Tableau des employés -->
  <ion-card class="table-card" *ngIf="listeEmploye && listeEmploye.length > 0">
    <ion-grid class="custom-table">
      <!-- En-tête -->
      <ion-row class="table-header">
        <ion-col size="0.6" class="checkbox-col">
          <!-- [checked]="selectAll" -->
          <ion-checkbox
            [checked]="selectAllCheckBox"
            (ionChange)="onSelectAllChange($event)"
            [disabled]="allCheckboxDisabled()"
          ></ion-checkbox>
        </ion-col>
        <ion-col size="0.6">ID</ion-col>
        <ion-col size="1.3">Statut</ion-col>
        <ion-col size="2">Nom complet</ion-col>
        <ion-col size="1.5">Salaire Brut</ion-col>
        <ion-col size="1.5">Salaire Net</ion-col>
        <ion-col size="1.5">Total Retenu</ion-col>
        <ion-col size="3">Note de Paiement</ion-col>
      </ion-row>

      <!-- Lignes des employés -->
      <ion-row
        *ngFor="let user of listeEmploye | filter: searchTerm"
        class="table-row"
        [class.row-disabled]="user.SALAIRE.SALAIRE_NET <= 0"
        [class.row-success]="user.status === 'succès'"
        [class.row-error]="user.status === 'échec'"
      >
        <ion-col size="0.6" class="checkbox-col">
          <ion-checkbox
            [(ngModel)]="user.selected"
            (ionChange)="updateSelection(user)"
            [disabled]="user.SALAIRE.SALAIRE_NET <= 0"
          ></ion-checkbox>
        </ion-col>
        <ion-col size="0.6">
          <span class="employee-id">{{ user.IDEMPLOYE }}</span>
        </ion-col>
        <ion-col size="1.3">
          <ion-badge
            [color]="user.status === 'paiement effectué' ? 'primary' : 
                     user.status === 'succès' ? 'success' : 
                     user.status === 'échec' ? 'danger' : 'medium'"
            class="status-badge"
          >
            {{ user.status || 'En attente' }}
            <ion-button 
              *ngIf="user.status === 'échec'" 
              size="small" 
              fill="clear" 
              [id]="'error-' + user.IDEMPLOYE"
              class="error-btn"
            >
              <ion-icon slot="icon-only" name="alert-circle-outline"></ion-icon>
            </ion-button>
          </ion-badge>
          <ion-popover 
            *ngIf="user.status === 'échec'" 
            [trigger]="'error-' + user.IDEMPLOYE" 
            triggerAction="click"
            side="right"
          >
            <ng-template>
              <ion-content class="error-popover">
                <div class="error-content">
                  <ion-icon name="warning" color="danger"></ion-icon>
                  <p>{{ user.TxErreur }}</p>
                </div>
              </ion-content>
            </ng-template>
          </ion-popover>
        </ion-col>
        <ion-col size="2">
          <div class="employee-name">
            <ion-icon name="person-circle-outline" color="medium"></ion-icon>
            <span>{{ user.EMPLOYE.PRENOM }} {{ user.EMPLOYE.NOM }}</span>
          </div>
        </ion-col>
        <ion-col size="1.5">
          <span class="salary-amount">{{ user.SALAIRE.SALAIRE_BRUT | currency:'XOF':'symbol':'1.0-0' }}</span>
        </ion-col>
        <ion-col size="1.5">
          <ion-input
            type="number"
            [(ngModel)]="user.SALAIRE.SALAIRE_NET"
            [readonly]="!isEditMode"
            [class.editable-field]="isEditMode"
            (ionChange)="onSalaryChange(user)"
            class="salary-input"
          ></ion-input>
        </ion-col>
        <ion-col size="1.5">
          <span class="salary-amount retenu">{{ user.SALAIRE.TOTAL_RETENU | currency:'XOF':'symbol':'1.0-0' }}</span>
        </ion-col>
        <ion-col size="3">
          <ion-item lines="none" class="note-item">
            <ion-textarea
              [(ngModel)]="user.noteModePaiement"
              placeholder="Ajouter une note..."
              rows="1"
              auto-grow="true"
              class="note-textarea"
            ></ion-textarea>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-card>

  <!-- Message si aucun employé -->
  <ion-card *ngIf="!listeEmploye || listeEmploye.length === 0" class="empty-state">
    <ion-card-content>
      <ion-icon name="people-outline" color="medium"></ion-icon>
      <h2>Aucun employé trouvé</h2>
      <p>Aucun employé n'est disponible pour cette période.</p>
    </ion-card-content>
  </ion-card>

  <!-- Input file caché pour l'import -->
  <input
    type="file"
    id="importFileInput"
    accept=".xlsx,.xls,.csv"
    (change)="onFileSelected($event)"
    style="display: none;"
  />
</ion-content>