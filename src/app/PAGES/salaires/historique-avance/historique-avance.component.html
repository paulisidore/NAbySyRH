<!-- Pas de header car déjà dans la page parent -->
<div class="historique-container">
  
  <!-- Titre de la section -->
  <ion-card class="title-card">
    <ion-card-content>
      <h1 class="main-title">
        <ion-icon name="time-outline"></ion-icon>
        Historique des Demandes d'Avance
      </h1>
    </ion-card-content>
  </ion-card>

  <!-- Statistiques -->
  <ion-card class="stats-card">
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="6" size-md="2">
            <div class="stat-item">
              <ion-icon name="documents-outline" color="primary"></ion-icon>
              <h2>{{ statistiques.total }}</h2>
              <p>Total demandes</p>
            </div>
          </ion-col>
          <ion-col size="6" size-md="2">
            <div class="stat-item">
              <ion-icon name="time-outline" color="warning"></ion-icon>
              <h2>{{ statistiques.enAttente }}</h2>
              <p>En attente</p>
            </div>
          </ion-col>
          <ion-col size="6" size-md="2">
            <div class="stat-item">
              <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
              <h2>{{ statistiques.acceptees }}</h2>
              <p>Acceptées</p>
              <small class="montant-stat">{{ statistiques.montantAccepte | number:'1.0-0' }} FCFA</small>
            </div>
          </ion-col>
          <ion-col size="6" size-md="2">
            <div class="stat-item">
              <ion-icon name="close-circle-outline" color="danger"></ion-icon>
              <h2>{{ statistiques.rejetees }}</h2>
              <p>Rejetées</p>
              <small class="montant-stat">{{ statistiques.montantRejete | number:'1.0-0' }} FCFA</small>
            </div>
          </ion-col>
          <ion-col size="6" size-md="2">
            <div class="stat-item">
              <ion-icon name="cash-outline" color="tertiary"></ion-icon>
              <h2>{{ statistiques.montantTotal | number:'1.0-0' }}</h2>
              <p>Total (FCFA)</p>
            </div>
          </ion-col>
          <ion-col size="6" size-md="2">
            <div class="stat-item stat-add">
              <ion-button 
                color="success" 
                size="large"
                shape="round"
                (click)="ajouterNouvelleDemande()">
                <ion-icon slot="icon-only" name="add-circle"></ion-icon>
              </ion-button>
              <p class="add-label">Nouvelle demande</p>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Section Filtres -->
  <ion-card class="filtres-card">
    <ion-card-header>
      <ion-card-title class="filter-title">
        <ion-icon name="filter-outline"></ion-icon>
        Filtres de Recherche
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-searchbar 
              [(ngModel)]="filtres.recherche"
              (ionChange)="appliquerFiltres()"
              placeholder="Rechercher par nom, motif, montant..."
              animated>
            </ion-searchbar>
          </ion-col>
          
          <ion-col size="12" size-md="6">
            <ion-item lines="full">
              <ion-label>Filtrer par statut</ion-label>
              <ion-select 
                [(ngModel)]="filtres.etat"
                (ionChange)="appliquerFiltres()"
                interface="action-sheet"
                cancelText="Annuler"
                placeholder="Tous les statuts">
                <ion-select-option value="">Tous les statuts</ion-select-option>
                <ion-select-option value="DEMANDE_EN_ATTENTE">En attente</ion-select-option>
                <ion-select-option value="DEMANDE_ACCEPTE">Acceptée</ion-select-option>
                <ion-select-option value="DEMANDE_REJETER">Rejetée</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-item>
              <ion-label position="stacked">Date début</ion-label>
              <ion-input 
                type="date"
                [(ngModel)]="filtres.dateDebut"
                (ionChange)="appliquerFiltres()">
              </ion-input>
            </ion-item>
          </ion-col>
          
          <ion-col size="12" size-md="6">
            <ion-item>
              <ion-label position="stacked">Date fin</ion-label>
              <ion-input 
                type="date"
                [(ngModel)]="filtres.dateFin"
                (ionChange)="appliquerFiltres()">
              </ion-input>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col>
            <ion-button 
              expand="block" 
              fill="outline" 
              (click)="reinitialiserFiltres()">
              <ion-icon slot="start" name="refresh-outline"></ion-icon>
              Réinitialiser
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Barre d'actions -->
  <ion-card class="actions-card">
    <ion-card-content>
      <ion-grid>
        <ion-row class="ion-align-items-center">
          <ion-col size="12" size-md="4">
            <div class="resultats-info">
              <ion-text color="medium">
                <strong>{{ demandesFiltrees.length }}</strong> résultat(s) trouvé(s)
              </ion-text>
              <ion-button 
                size="small" 
                color="success" 
                class="btn-add"
                (click)="ajouterNouvelleDemande()">
                <ion-icon slot="icon-only" name="add-circle"></ion-icon>
              </ion-button>
            </div>
          </ion-col>
          
          <ion-col size="12" size-md="8">
            <div class="export-buttons">
              <ion-button 
                size="small" 
                color="danger" 
                (click)="exporterPDF()">
                <ion-icon slot="start" name="document-text-outline"></ion-icon>
                PDF
              </ion-button>
              
              <ion-button 
                size="small" 
                color="success" 
                (click)="exporterExcel()">
                <ion-icon slot="start" name="grid-outline"></ion-icon>
                Excel
              </ion-button>
              
              <ion-button 
                size="small" 
                color="tertiary" 
                (click)="exporterCSV()">
                <ion-icon slot="start" name="document-outline"></ion-icon>
                CSV
              </ion-button>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Tableau responsive -->
  <ion-card class="table-card">
    <ion-card-content class="ion-no-padding">
      <!-- Vue Desktop -->
      <div class="table-container hide-on-mobile">
        <table class="custom-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Employé</th>
              <th>Motif</th>
              <th>Montant</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let demande of paginatedItems">
              <td>{{ demande.DateDemande | date:'dd/MM/yyyy' }}</td>
              <td>
                <div class="employe-info">
                  <ion-avatar class="avatar-small">
                    <ion-icon name="person"></ion-icon>
                  </ion-avatar>
                  <div>
                    <strong>{{ demande.PRENOM }} {{ demande.NOM }}</strong>
                  </div>
                </div>
              </td>
              <td>{{ demande.Motif }}</td>
              <td class="montant">{{ demande.Montant }} FCFA</td>
              <td>
                <ion-chip [color]="getEtatColor(demande.Etat)">
                  <ion-label>{{ getEtatLibelle(demande.Etat) }}</ion-label>
                </ion-chip>
              </td>
              <td>
                <div class="action-buttons">
                  <!-- Actions employé : Modifier et Supprimer -->
                  <ion-button 
                    fill="clear" 
                    size="small"
                    color="primary"
                    [disabled]="!peutModifierOuSupprimer(demande)"
                    (click)="modifierDemande(demande)"
                    *ngIf="!estAdministrateur">
                    <ion-icon name="create-outline"></ion-icon>
                  </ion-button>
                  <ion-button 
                    fill="clear" 
                    size="small"
                    color="danger"
                    [disabled]="!peutModifierOuSupprimer(demande)"
                    (click)="confirmerSuppression(demande)"
                    *ngIf="!estAdministrateur">
                    <ion-icon name="trash-outline"></ion-icon>
                  </ion-button>

                  <!-- Actions administrateur : Valider et Rejeter -->
                  <ion-button 
                    fill="clear" 
                    size="small"
                    color="success"
                    [disabled]="!peutValiderOuRejeter(demande)"
                    (click)="confirmerValidation(demande)"
                    *ngIf="estAdministrateur">
                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                  </ion-button>
                  <ion-button 
                    fill="clear" 
                    size="small"
                    color="danger"
                    [disabled]="!peutValiderOuRejeter(demande)"
                    (click)="confirmerRejet(demande)"
                    *ngIf="estAdministrateur">
                    <ion-icon name="close-circle-outline"></ion-icon>
                  </ion-button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Vue Mobile -->
      <div class="mobile-cards show-on-mobile">
        <ion-card *ngFor="let demande of paginatedItems" class="demande-card">
          <ion-card-content>
            <div class="card-header">
              <div class="employe-info">
                <ion-avatar>
                  <ion-icon name="person"></ion-icon>
                </ion-avatar>
                <div>
                  <strong>{{ demande.PRENOM }} {{ demande.NOM }}</strong>
                  <ion-text color="medium">
                    <small>{{ demande.DateDemande | date:'dd/MM/yyyy' }}</small>
                  </ion-text>
                </div>
              </div>
              <ion-chip [color]="getEtatColor(demande.Etat)">
                <ion-label>{{ getEtatLibelle(demande.Etat) }}</ion-label>
              </ion-chip>
            </div>

            <ion-item lines="none">
              <ion-icon name="document-text-outline" slot="start"></ion-icon>
              <ion-label>
                <p>Motif</p>
                <h3>{{ demande.Motif }}</h3>
              </ion-label>
            </ion-item>

            <ion-item lines="none">
              <ion-icon name="cash-outline" slot="start"></ion-icon>
              <ion-label>
                <p>Montant</p>
                <h3 class="montant-mobile">{{ demande.Montant }} FCFA</h3>
              </ion-label>
            </ion-item>

            <ion-button expand="block" fill="outline" size="small">
              <ion-icon slot="start" name="eye-outline"></ion-icon>
              Détails
            </ion-button>

            <!-- Actions employé -->
            <ion-row class="mobile-actions" *ngIf="!estAdministrateur">
              <ion-col size="6">
                <ion-button 
                  expand="block" 
                  fill="clear" 
                  size="small"
                  color="primary"
                  [disabled]="!peutModifierOuSupprimer(demande)"
                  (click)="modifierDemande(demande)">
                  <ion-icon slot="start" name="create-outline"></ion-icon>
                  Modifier
                </ion-button>
              </ion-col>
              <ion-col size="6">
                <ion-button 
                  expand="block" 
                  fill="clear" 
                  size="small"
                  color="danger"
                  [disabled]="!peutModifierOuSupprimer(demande)"
                  (click)="confirmerSuppression(demande)">
                  <ion-icon slot="start" name="trash-outline"></ion-icon>
                  Supprimer
                </ion-button>
              </ion-col>
            </ion-row>

            <!-- Actions administrateur -->
            <ion-row class="mobile-actions" *ngIf="estAdministrateur">
              <ion-col size="6">
                <ion-button 
                  expand="block" 
                  fill="clear" 
                  size="small"
                  color="success"
                  [disabled]="!peutValiderOuRejeter(demande)"
                  (click)="confirmerValidation(demande)">
                  <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
                  Valider
                </ion-button>
              </ion-col>
              <ion-col size="6">
                <ion-button 
                  expand="block" 
                  fill="clear" 
                  size="small"
                  color="danger"
                  [disabled]="!peutValiderOuRejeter(demande)"
                  (click)="confirmerRejet(demande)">
                  <ion-icon slot="start" name="close-circle-outline"></ion-icon>
                  Rejeter
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-card-content>
        </ion-card>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Pagination -->
  <ion-card class="pagination-card" *ngIf="demandesFiltrees.length > 0">
    <ion-card-content>
      <ion-grid>
        <ion-row class="ion-align-items-center">
          <ion-col size="12" size-md="4">
            <ion-item lines="none">
              <ion-label>Éléments par page:</ion-label>
              <ion-select 
                [(ngModel)]="itemsPerPage"
                (ionChange)="onItemsPerPageChange()"
                interface="popover">
                <ion-select-option *ngFor="let option of paginationOptions" [value]="option">
                  {{ option }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>

          <ion-col size="12" size-md="8">
            <div class="pagination-controls">
              <ion-button 
                fill="clear" 
                [disabled]="currentPage === 1"
                (click)="onPageChange(currentPage - 1)">
                <ion-icon name="chevron-back-outline"></ion-icon>
              </ion-button>

              <ion-button 
                *ngFor="let page of pages"
                [fill]="currentPage === page ? 'solid' : 'clear'"
                [color]="currentPage === page ? 'primary' : 'medium'"
                size="small"
                (click)="onPageChange(page)">
                {{ page }}
              </ion-button>

              <ion-button 
                fill="clear"
                [disabled]="currentPage === totalPages"
                (click)="onPageChange(currentPage + 1)">
                <ion-icon name="chevron-forward-outline"></ion-icon>
              </ion-button>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Message si aucun résultat -->
  <ion-card *ngIf="demandesFiltrees.length === 0" class="empty-state">
    <ion-card-content class="ion-text-center">
      <ion-icon name="folder-open-outline" color="medium"></ion-icon>
      <h2>Aucune demande trouvée</h2>
      <p>Essayez de modifier vos critères de recherche</p>
      <ion-button fill="outline" (click)="reinitialiserFiltres()">
        Réinitialiser les filtres
      </ion-button>
    </ion-card-content>
  </ion-card>
</div>
<!-- Fin du container -->